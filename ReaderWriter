#include <iostream>
#include <thread>
#include <chrono>
#include <mutex>

using namespace std;

int shared_data = 0 ;
int reader_count = 0;
mutex reader_count_mutex;
mutex resource_mutex;

void reader(int id){
    for(int i = 0 ; i< 2;i++){
        {
        lock_guard <mutex> lock(reader_count_mutex);
        reader_count++;
        if(reader_count == 1){
            resource_mutex.lock();
        }
        }
        cout<<"Reader\t"<<id<<" is reading Shared Data = "<<shared_data<<endl;
   
    this_thread::sleep_for(chrono::milliseconds(200));
    cout << "Reader " << id << " finished reading." << endl;
    {
        lock_guard <mutex> lock(reader_count_mutex);
        reader_count--;
        if(reader_count == 0){
            resource_mutex.unlock();
        }
    }
        this_thread::sleep_for(chrono::milliseconds(200));
    
}
}
void writer(int id){
    for(int i = 0 ; i<2 ; i++){
          resource_mutex.lock();
          shared_data += 10;
          cout << "Writer " << id << " is writing. Updated Shared Data = " << shared_data << endl;
        this_thread::sleep_for(chrono::milliseconds(250));
        cout << "Writer " << id << " finished writing." << endl;
        resource_mutex.unlock();
        this_thread::sleep_for(chrono::milliseconds(250));
    }
  
    
}

int main(){
    int numR;
    int numW;
    cout<<"Enter the number of readers:\t"<<endl;
    cin>>numR;
    cout<<"Enter the number of Writers:\t"<<endl;
    cin>>numW;
    // thread readers[numR];
    // thread writers[numW];
    thread* readers = new thread[numR];
    thread* writers = new thread[numW];
    for(int i = 0; i<numR; i++){
        readers[i] = thread(reader,i+1);
    }
    for(int i = 0; i<numW; i++){
        writers[i] = thread(writer,i+1);
    }
    for(int i = 0 ;i<numR;i++){
        readers[i].join();
    }
    for(int i = 0;i<numW;i++){
        writers[i].join();
    }
    delete[] readers;
    delete[] writers;
    cout << "\nFinal Shared Data = " << shared_data << endl;
    return 0;
}
